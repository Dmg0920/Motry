{% extends "core/base.html" %}
{% load motry_extras %}
{% block content %}
<div class="page-container">
	<div class="layout layout--with-sidebar layout--align-top">
		<!-- 手機版搜尋按鈕 -->
		<button type="button" class="mobile-search-toggle" id="mobile-search-toggle" aria-label="開啟搜尋條件" aria-expanded="false">
			<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<circle cx="11" cy="11" r="8"></circle>
				<path d="m21 21-4.3-4.3"></path>
			</svg>
			<span>搜尋條件</span>
		</button>

		<!-- 手機版遮罩 -->
		<div class="mobile-search-overlay" id="mobile-search-overlay"></div>

		<aside class="card search-sidebar" id="search-sidebar">
			<div class="section-heading">
				<h2>搜尋條件</h2>
				<button type="button" class="mobile-search-close" id="mobile-search-close" aria-label="關閉搜尋條件">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M18 6 6 18"></path>
						<path d="m6 6 12 12"></path>
					</svg>
				</button>
			</div>
			<form action="/search" method="get" class="search-panel">
				<div class="search-panel__row">
					<input type="text" name="query" placeholder="輸入車名或品牌" value="{{ query }}" />
				</div>
				<div class="search-panel__row">
					<select name="type" id="results-search-type" class="form-select form-select--compact">
						<option value="" {% if not type %}selected{% endif %}>全部類型</option>
						<option value="car" {% if type == "car" %}selected{% endif %}>汽車</option>
						<option value="bike" {% if type == "bike" %}selected{% endif %}>機車</option>
					</select>
					<select
						name="brand"
						class="form-select form-select--compact"
						data-brand-select
						data-type-input="#results-search-type"
						data-selected-value="{{ brand }}"
					>
						<option value="">全部品牌</option>
					</select>
				</div>
				<div class="search-panel__row">
					<span>
						<label>排氣量 (cc)</label>
						<input type="number" name="displacement_min" placeholder="最小" value="{{ displacement_min }}" min="0" />
					</span>
					<span>
						<label>&nbsp;</label>
						<input type="number" name="displacement_max" placeholder="最大" value="{{ displacement_max }}" min="0" />
					</span>
				</div>
				<div class="search-panel__row">
					<span>
						<label>馬力 (PS)</label>
						<input type="number" name="hp_min" placeholder="最小" value="{{ hp_min }}" min="0" />
					</span>
					<span>
						<label>&nbsp;</label>
						<input type="number" name="hp_max" placeholder="最大" value="{{ hp_max }}" min="0" />
					</span>
				</div>
				<div class="search-panel__row">
					<span>
						<label>缸數</label>
						<input type="text" name="cylinders" placeholder="例：2,4" value="{{ cylinders }}" />
					</span>
				</div>
				<button type="submit" class="button">更新條件</button>
			</form>
		</aside>

		<section class="page-stack">
			<div class="card">
				<div class="results-summary">
					<h2>搜尋結果</h2>
					{% if vehicles %}
						<span>共 {{ page_obj.paginator.count|default:vehicles|length }} 筆符合條件</span>
					{% else %}
						<span>尚未找到符合項目</span>
					{% endif %}
					{% if user.is_staff %}
						<button type="button" id="export-csv-btn" class="button button-ghost" style="margin-left: auto;">
							匯出 CSV
						</button>
					{% endif %}
				</div>
				<p class="hero-subtitle hero-subtitle--compact">
					調整左側條件即可即時更新結果。點擊車款可查看完整規格與車主心得。
				</p>
			</div>

			{% if vehicles %}
				<div class="result-list">
					{% for v in vehicles %}
					<a href="/vehicle/{{ v.id }}/" class="vehicle-card">
						<div class="vehicle-card__media">
							{% vehicle_showcase_image v as vehicle_result_photo %}
							{% if vehicle_result_photo %}
								<img
									src="{{ vehicle_result_photo }}"
									alt="{{ v.brand }} {{ v.model }}"
									data-fallback="{% vehicle_fallback_image v.brand v.model %}"
								/>
							{% else %}
								<img
									src="{% vehicle_fallback_image v.brand v.model %}"
									alt="{{ v.brand }} {{ v.model }}"
								/>
							{% endif %}
						</div>
							<div class="vehicle-card__body">
								<div>
									<h3 class="vehicle-card__title">{{ v.brand }} {{ v.model }}</h3>
									<p class="vehicle-card__meta">
										{% if v.years_from %}{{ v.years_from }}{% endif %}
										{% if v.years_to %} - {{ v.years_to }}{% endif %}
										{% if not v.years_from and not v.years_to %}年份資訊待補{% endif %}
									</p>
								</div>
								<ul class="pill-list">
									{% if v.displacement_cc %}
										<li class="pill">{{ v.displacement_cc }} cc</li>
									{% endif %}
									{% if v.cylinders %}
										<li class="pill">{{ v.cylinders }} 缸</li>
									{% endif %}
									{% if v.horsepower_ps %}
										<li class="pill">{{ v.horsepower_ps }} PS</li>
									{% endif %}
									{% if v.msrp_new %}
										<li class="pill">新車約 {{ v.msrp_new|floatformat:0 }} 元</li>
									{% endif %}
								</ul>
							</div>
						</a>
					{% endfor %}
				</div>
			{% else %}
				<p class="empty-state">沒有符合的車款，試著放寬條件或搜尋其他關鍵字。</p>
			{% endif %}

			{% if page_obj and page_obj.has_other_pages %}
			<nav class="pagination" aria-label="Search results pages" style="margin-top: 16px;">
				<ul class="pager">
					{% with params=request.GET.urlencode %}
						{% if page_obj.has_previous %}
							<li><a href="?{% if params %}{{ params|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.previous_page_number }}">上一頁</a></li>
						{% endif %}
						<li>第 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 頁</li>
						{% if page_obj.has_next %}
							<li><a href="?{% if params %}{{ params|cut:'page='|cut:'&page=' }}&{% endif %}page={{ page_obj.next_page_number }}">下一頁</a></li>
						{% endif %}
					{% endwith %}
				</ul>
			</nav>
			{% endif %}
		</section>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 手機版搜尋面板切換
(function() {
	const toggle = document.getElementById('mobile-search-toggle');
	const close = document.getElementById('mobile-search-close');
	const sidebar = document.getElementById('search-sidebar');
	const overlay = document.getElementById('mobile-search-overlay');

	if (!toggle || !sidebar) return;

	function openSearch() {
		sidebar.classList.add('active');
		overlay.classList.add('active');
		toggle.setAttribute('aria-expanded', 'true');
		document.body.style.overflow = 'hidden';
	}

	function closeSearch() {
		sidebar.classList.remove('active');
		overlay.classList.remove('active');
		toggle.setAttribute('aria-expanded', 'false');
		document.body.style.overflow = '';
	}

	toggle.addEventListener('click', openSearch);
	close.addEventListener('click', closeSearch);
	overlay.addEventListener('click', closeSearch);

	// ESC 鍵關閉
	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape' && sidebar.classList.contains('active')) {
			closeSearch();
		}
	});
})();
</script>
{% if user.is_staff %}
<script>
(function() {
	const btn = document.getElementById('export-csv-btn');
	if (!btn) return;

	btn.addEventListener('click', async function() {
		const originalText = btn.textContent;
		btn.disabled = true;
		btn.textContent = '處理中...';

		try {
			// 1. 觸發匯出任務
			const exportRes = await fetch('/api/export/vehicles/', {
				method: 'POST',
				headers: {
					'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
						document.cookie.match(/csrftoken=([^;]+)/)?.[1] || ''
				}
			});
			const exportData = await exportRes.json();

			if (!exportData.success) {
				throw new Error(exportData.message || '匯出失敗');
			}

			const taskId = exportData.task_id;
			btn.textContent = '排程中...';

			// 2. 輪詢任務狀態
			let attempts = 0;
			const maxAttempts = 30; // 最多等待 30 秒

			const pollStatus = async () => {
				attempts++;
				const statusRes = await fetch(`/api/export/status/${taskId}/`);
				const statusData = await statusRes.json();

				if (statusData.status === 'SUCCESS') {
					btn.textContent = '下載中...';
					// 下載檔案
					if (statusData.result) {
						const link = document.createElement('a');
						link.href = statusData.result;
						link.download = '';
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
					}
					btn.disabled = false;
					btn.textContent = originalText;
					alert('匯出完成！');
				} else if (statusData.status === 'FAILURE') {
					throw new Error(statusData.result || '任務執行失敗');
				} else if (attempts < maxAttempts) {
					btn.textContent = `處理中 (${attempts}s)...`;
					setTimeout(pollStatus, 1000);
				} else {
					throw new Error('任務超時，請稍後再試');
				}
			};

			await pollStatus();

		} catch (err) {
			alert('匯出失敗: ' + err.message);
			btn.disabled = false;
			btn.textContent = originalText;
		}
	});
})();
</script>
{% endif %}
{% endblock %}
