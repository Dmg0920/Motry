{% load motry_extras %}

<article class="comment comment--depth-{{ comment.get_depth }}" id="comment-{{ comment.id }}" data-comment-depth="{{ comment.get_depth }}">
    <div class="comment__avatar" aria-hidden="true">
        {% if comment.user and comment.user.username %}
            {{ comment.user.username|first|upper }}
        {% else %}
            å®¢
        {% endif %}
    </div>

    <div class="comment__content">
        <header class="comment__header">
            <strong>{{ comment.user.username|default:"åŒ¿åè»Šå‹" }}</strong>
            <span>{{ comment.created_at|timesince }} å‰</span>
        </header>

        <p class="comment__text">{{ comment.body_text }}</p>

        {% if comment.image %}
            <img src="{{ comment.image.url }}" alt="ç•™è¨€åœ–ç‰‡" class="comment__image" />
        {% elif comment.image_url and not comment.image_url|is_default_image %}
            <img src="{{ comment.image_url }}" alt="ç•™è¨€åœ–ç‰‡" class="comment__image" />
        {% endif %}

        <div class="comment__toolbar">
            {# é¡¯ç¤ºå›è¦†æŒ‰éˆ• #}
            {% if user.is_authenticated and comment.can_reply %}
                <button type="button" class="comment__reply-toggle" data-reply-toggle data-target="reply-form-{{ comment.id }}">å›è¦†</button>
            {% endif %}

            {# é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•ï¼šä½œè€…æœ¬äºº OR ç®¡ç†å“¡(Staff) #}
            {% if user.is_authenticated %}
                {% if comment.user_id == user.id or user.is_staff %}
                    <form action="{% url 'delete_comment' comment.id %}" method="POST" class="comment__delete-form" style="display:inline;" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡è©•è«–å—ï¼Ÿ');">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                        
                        <button type="submit" class="btn btn-sm btn-danger" style="color: red; border: none; background: none; cursor: pointer;">
                            {% if comment.user_id == user.id %}
                                åˆªé™¤
                            {% else %}
                                åˆªé™¤é•è¦
                            {% endif %}
                        </button>
                    </form>
                {% endif %}
            {% endif %}
        </div>

        {# 4. éè¿´é¡¯ç¤ºå­ç•™è¨€ #}
        <div class="comment__replies" data-replies-container="{{ comment.id }}">
            {% comment %} 
                é€™è£¡é€šå¸¸æœƒé€ééè¿´ include è‡ªå·±ä¾†é¡¯ç¤ºå­ç•™è¨€ï¼Œ
                æˆ–è€…ç”± JavaScript å‹•æ…‹è¼‰å…¥
            {% endcomment %}
        </div>

        {# 5. å›è¦†è¡¨å–® (é è¨­éš±è—) #}
        {% if user.is_authenticated and comment.can_reply %}
            <form
                action="#" 
                method="post"
                enctype="multipart/form-data"
                class="comment-form comment-form--inline comment-reply-form"
                id="reply-form-{{ comment.id }}"
                data-comment-form
                data-parent-id="{{ comment.id }}"
                data-post-id="{{ comment.post_id }}"
                hidden
            >
                {% csrf_token %}
                <div class="comment-form__fields">
                    <textarea
                        name="body_text"
                        rows="1"
                        placeholder="å›è¦† {{ comment.user.username|default:'è»Šå‹' }}â€¦"
                        class="comment-form__input"
                        required
                    ></textarea>
                    <div class="comment-form__actions comment-form__actions--inline">
                        <label class="comment-form__upload" title="ä¸Šå‚³åœ–ç‰‡">
                            ğŸ“·
                            <input type="file" name="image" accept="image/*" class="comment-form__file-input" />
                        </label>
                        <input type="url" name="image_url" placeholder="åœ–ç‰‡ç¶²å€ï¼ˆé¸å¡«ï¼‰" class="comment-form__url comment-form__url--inline" />
                        <button type="submit" class="comment-form__submit">é€å‡º</button>
                    </div>
                </div>
            </form>
        {% endif %}
    </div>
</article>