{% extends "core/base.html" %}
{% load static motry_extras %}
{% block content %}
<div class="page-container page-stack">
	<section class="layout layout--split layout--align-top">
		<div class="card vehicle-visual">
			<div class="vehicle-hero__media">
				{% if vehicle.images.first and not vehicle.images.first.image_url|is_default_image %}
					<img
						src="{{ vehicle.images.first.image_url }}"
						alt="{{ vehicle.brand }} {{ vehicle.model }}"
						data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
					/>
				{% elif vehicle.cover_url and not vehicle.cover_url|is_default_image %}
					<img
						src="{{ vehicle.cover_url }}"
						alt="{{ vehicle.brand }} {{ vehicle.model }}"
						data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
					/>
				{% else %}
					<img
						src="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
						alt="{{ vehicle.brand }} {{ vehicle.model }}"
					/>
				{% endif %}
			</div>
			{% if user.is_authenticated %}
				<div class="hero-actions">
					<button
						type="button"
						class="button button-ghost garage-toggle-button"
						data-garage-toggle
						data-vehicle-id="{{ vehicle.id }}"
						data-in-garage="{% if user_vehicle_entry %}true{% else %}false{% endif %}"
					>
						{% if user_vehicle_entry %}
							â¤ï¸ å·²åœ¨æˆ‘çš„è»Šåº«
						{% else %}
							ğŸ¤ åŠ å…¥æˆ‘çš„è»Šåº«
						{% endif %}
					</button>
					<a href="{% url 'post_create' %}?vehicle={{ vehicle.id }}" class="button">ç™¼è¡¨å¿ƒå¾—</a>
					<a href="{% url 'user_garage' %}" class="button button-ghost">ç®¡ç†æˆ‘çš„è»Šåº«</a>
				</div>
				<p class="hero-subtitle hero-subtitle--compact" data-garage-status>
					{% if user_vehicle_entry %}
						å·²æ–¼ {{ user_vehicle_entry.created_at|date:"Y-m-d" }} æ”¶è—ï¼Œå¯åœ¨ã€Œæˆ‘çš„è»Šåº«ã€ç®¡ç†å‚™è¨»èˆ‡ç…§ç‰‡ã€‚
					{% else %}
						æ”¶è—å¾Œå¯åœ¨ã€Œæˆ‘çš„è»Šåº«ã€å¿«é€Ÿç®¡ç†è»Šè¼›èˆ‡ç™¼è¡¨å¿ƒå¾—ã€‚
					{% endif %}
				</p>
			{% else %}
				<p class="hero-subtitle hero-subtitle--compact">ç™»å…¥å¾Œå³å¯æ”¶è—é€™å°è»Šä¸¦åˆ†äº«ä½ çš„ä½¿ç”¨å¿ƒå¾—ã€‚</p>
				<div class="hero-actions">
					<a href="{% url 'login' %}?next=/vehicle/{{ vehicle.id }}/" class="button">ç™»å…¥åˆ†äº«</a>
					<a href="{% url 'register' %}" class="button button-ghost">åŠ å…¥ç¤¾ç¾¤</a>
				</div>
			{% endif %}
		</div>

		<div class="card vehicle-summary stack-sm">
			<span class="badge badge--ghost">Vehicle Overview</span>
			<h1 class="hero-title">{{ vehicle.brand }} {{ vehicle.model }}</h1>
			<p class="hero-subtitle">
				{% if vehicle.type == 'car' %}æ±½è»Š{% elif vehicle.type == 'bike' %}æ©Ÿè»Š{% else %}{{ vehicle.type }}{% endif %}
				{% if vehicle.years_from or vehicle.years_to %}
					ï½œå¹´ä»½ {{ vehicle.years_from|default:"?" }}{% if vehicle.years_to %} - {{ vehicle.years_to }}{% endif %}
				{% endif %}
			</p>
			<ul class="spec-pill-list">
				{% if vehicle.displacement_cc %}
					<li class="spec-pill">{{ vehicle.displacement_cc }} cc</li>
				{% endif %}
				{% if vehicle.cylinders %}
					<li class="spec-pill">{{ vehicle.cylinders }} ç¼¸</li>
				{% endif %}
				{% if vehicle.horsepower_ps %}
					<li class="spec-pill">{{ vehicle.horsepower_ps }} PS</li>
				{% endif %}
				{% if vehicle.generation %}
					<li class="spec-pill">{{ vehicle.generation }}</li>
				{% endif %}
			</ul>
			<div class="rating-block">
				<div class="rating-summary">
					<strong class="rating-summary__score">
						{% if vehicle.rating_count %}
							{{ vehicle.avg_rating|floatformat:1 }}
						{% else %}
							â€“
						{% endif %}
					</strong>
					<span class="rating-summary__label">å¹³å‡è©•åˆ†ï¼ˆå…± {{ vehicle.rating_count|default:0 }} å‰‡ï¼‰</span>
				</div>
				{% if rating_form %}
					<form action="{% url 'rate_vehicle' vehicle.id %}" method="post" class="rating-form inline-form inline-form--compact">
						{% csrf_token %}
						{{ rating_form.score }}
						<input type="hidden" name="next" value="{{ request.get_full_path }}" />
						<button type="submit" class="button">
							{% if user_rating %}æ›´æ–°è©•åˆ†{% else %}é€å‡ºè©•åˆ†{% endif %}
						</button>
					</form>
				{% elif not user.is_authenticated %}
					<p class="rating-login-hint">ç™»å…¥å¾Œå³å¯ç‚ºé€™å°è»Šè©•åˆ†ã€‚</p>
				{% endif %}
			</div>
			{% if vehicle.intro_md %}
				<div class="vehicle-intro">
					<h3 style="margin-top: 0; margin-bottom: 12px;">è»Šè¼›ç°¡ä»‹</h3>
					<div style="white-space: pre-wrap; line-height: 1.8;">{{ vehicle.intro_md }}</div>
				</div>
			{% endif %}
			<div class="spec-table">
				<h3 style="margin-top: 0; margin-bottom: 16px;">è©³ç´°è¦æ ¼</h3>
				{% if vehicle.years_from or vehicle.years_to %}
					<div class="spec-row">
						<strong>ä¸Šå¸‚å¹´ä»½</strong>
						<span>{{ vehicle.years_from|default:"-" }}{% if vehicle.years_to %} - {{ vehicle.years_to }}{% endif %}</span>
					</div>
				{% endif %}
				{% if vehicle.generation %}
					<div class="spec-row">
						<strong>ä¸–ä»£ / ä»£è™Ÿ</strong>
						<span>{{ vehicle.generation }}</span>
					</div>
				{% endif %}
				<div class="spec-row">
					<strong>æ’æ°£é‡</strong>
					<span>{% if vehicle.displacement_cc %}{{ vehicle.displacement_cc }} cc{% else %}-{% endif %}</span>
				</div>
				<div class="spec-row">
					<strong>ç¼¸æ•¸</strong>
					<span>{% if vehicle.cylinders %}{{ vehicle.cylinders }} ç¼¸{% else %}-{% endif %}</span>
				</div>
				<div class="spec-row">
					<strong>é¦¬åŠ›</strong>
					<span>{% if vehicle.horsepower_ps %}{{ vehicle.horsepower_ps }} PS{% else %}-{% endif %}</span>
				</div>
				{% if vehicle.msrp_new %}
					<div class="spec-row">
						<strong>æ–°è»Šå»ºè­°å”®åƒ¹</strong>
						<span>{{ vehicle.msrp_new|floatformat:0 }} å…ƒ</span>
					</div>
				{% endif %}
				{% if vehicle.used_price_min or vehicle.used_price_max %}
					<div class="spec-row">
						<strong>ä¸­å¤è»Šåƒ¹æ ¼</strong>
						<span>
							{% if vehicle.used_price_min %}{{ vehicle.used_price_min|floatformat:0 }}{% else %}?{% endif %}
							{% if vehicle.used_price_min and vehicle.used_price_max %} - {% endif %}
							{% if vehicle.used_price_max %}{{ vehicle.used_price_max|floatformat:0 }}{% endif %}
							{% if vehicle.used_price_min or vehicle.used_price_max %} å…ƒ{% endif %}
						</span>
					</div>
				{% endif %}
				<div class="spec-row">
					<strong>è³‡æ–™å»ºç«‹æ™‚é–“</strong>
					<span>{{ vehicle.created_at|date:"Y-m-d" }}</span>
				</div>
				{% if vehicle.updated_at %}
					<div class="spec-row">
						<strong>æœ€å¾Œæ›´æ–°</strong>
						<span>{{ vehicle.updated_at|date:"Y-m-d" }}</span>
					</div>
				{% endif %}
			</div>
		</div>
	</section>

	<section class="card">
		<div class="section-heading">
			<div>
				<h2>å®˜æ–¹åœ–é›†</h2>
				<p class="hero-subtitle hero-subtitle--compact">ç€è¦½å¤–è§€èˆ‡ç´°ç¯€ç…§ï¼Œäº†è§£è»Šèº«è³ªæ„Ÿã€‚</p>
			</div>
		</div>
		{% if vehicle.images.all %}
			{% if vehicle.images.first.image_url|is_default_image and vehicle.images.all|length == 1 %}
				<p class="empty-state">å°šæœªä¸Šå‚³å®˜æ–¹ç…§ç‰‡ï¼Œæ­¡è¿è£œå……ï¼</p>
			{% else %}
				<div class="gallery-strip">
					{% for img in vehicle.images.all %}
						{% if not img.image_url|is_default_image %}
							<img
								src="{{ img.image_url }}"
								alt="{{ vehicle.model }} åœ–ç‰‡ {{ forloop.counter }}"
								data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
							/>
						{% endif %}
					{% endfor %}
				</div>
			{% endif %}
		{% else %}
			<p class="empty-state">å°šæœªä¸Šå‚³å®˜æ–¹ç…§ç‰‡ï¼Œæ­¡è¿è£œå……ï¼</p>
		{% endif %}
	</section>

	<section class="card">
		<div class="section-heading">
			<div>
				<h2>è»Šä¸»å¿ƒå¾—èˆ‡è¨è«–</h2>
				<p class="hero-subtitle hero-subtitle--compact">é–±è®€çœŸå¯¦è»Šä¸»å¿ƒå¾—èˆ‡ç•™è¨€ï¼ŒæŒæ¡ä½¿ç”¨æ„Ÿå—ã€‚</p>
			</div>
			{% if user.is_authenticated %}
				<a href="{% url 'post_create' %}?vehicle={{ vehicle.id }}" class="button button-ghost">æ’°å¯«å¿ƒå¾—</a>
			{% else %}
				<a href="{% url 'login' %}?next=/vehicle/{{ vehicle.id }}/" class="button button-ghost">ç™»å…¥å¾Œåˆ†äº«</a>
			{% endif %}
		</div>

		{% if vehicle.posts.all %}
			<div class="post-stack">
				{% for post in vehicle.posts.all %}
					<article class="post-card">
						<div class="post-card__body">
							{{ post.body_text|linebreaksbr }}
						</div>
						{% if post.images.all %}
							<div class="post-card__gallery">
								{% for pi in post.images.all %}
									{% if pi.image %}
										<img
											src="{{ pi.image.url }}"
											alt="è²¼æ–‡åœ–ç‰‡ {{ forloop.counter }}"
											data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
										/>
									{% elif pi.image_url and not pi.image_url|is_default_image %}
										<img
											src="{{ pi.image_url }}"
											alt="è²¼æ–‡åœ–ç‰‡ {{ forloop.counter }}"
											data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
										/>
									{% endif %}
								{% endfor %}
							</div>
						{% endif %}
						{% if post.post_tags.all %}
							<div class="post-card__tags">
								{% for pt in post.post_tags.all %}
									<span class="post-card__tag">#{{ pt.tag.name }}</span>
								{% endfor %}
							</div>
						{% endif %}
						<div class="post-card__meta">
							<span>ç”± {{ post.user.username|default:"åŒ¿åè»Šå‹" }} åˆ†äº«</span>
							<span>è®šï¼š{{ post.num_likes }}</span>
							<span>ç•™è¨€ï¼š{{ post.num_comments }}</span>
							<span>{{ post.created_at|date:"Y-m-d H:i" }}</span>
							{% if user.is_authenticated %}
								<form action="/like/toggle/{{ post.id }}/" method="post" class="inline-form inline-form--compact">
									{% csrf_token %}
									<button type="submit" class="button button-ghost">è®š / å–æ¶ˆè®š</button>
								</form>
								{% if post.user_id == user.id or user.is_staff %}
									<form action="{% url 'post_delete' post.id %}" method="post" class="inline-form inline-form--compact">
										{% csrf_token %}
										<input type="hidden" name="next" value="{{ request.get_full_path }}" />
										<button type="submit" class="button button-ghost">åˆªé™¤è²¼æ–‡</button>
									</form>
								{% endif %}
							{% endif %}
						</div>
						<section>
							<h4>ç•™è¨€</h4>
							{% if post.comments.all %}
								<div class="comment-list">
									{% for c in post.comments.all %}
										<div class="comment-item">
											<p>{{ c.body_text }}</p>
											{% if c.image %}
												<img
													src="{{ c.image.url }}"
													alt="ç•™è¨€åœ–ç‰‡"
													class="comment-image"
													data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
												/>
											{% elif c.image_url and not c.image_url|is_default_image %}
												<img
													src="{{ c.image_url }}"
													alt="ç•™è¨€åœ–ç‰‡"
													class="comment-image"
													data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
												/>
											{% endif %}
											<small>{{ c.created_at|date:"Y-m-d H:i" }}</small>
											{% if user.is_authenticated %}
												{% if c.user_id == user.id or user.is_staff %}
												<form action="{% url 'comment_delete' c.id %}" method="post" class="inline-form inline-form--compact comment-delete-form">
													{% csrf_token %}
													<input type="hidden" name="next" value="{{ request.get_full_path }}" />
													<button type="submit" class="button button-ghost">åˆªé™¤ç•™è¨€</button>
												</form>
												{% endif %}
											{% endif %}
										</div>
									{% endfor %}
								</div>
							{% else %}
								<p class="empty-state empty-state--compact">é‚„æ²’æœ‰ç•™è¨€ã€‚</p>
							{% endif %}

							{% if user.is_authenticated %}
								<form action="/comment/new" method="post" enctype="multipart/form-data" class="inline-form">
									{% csrf_token %}
									<input type="hidden" name="post" value="{{ post.id }}" />
									<textarea name="body_text" rows="2" placeholder="ç•™ä¸‹ä½ çš„çœ‹æ³•..." required></textarea>
									<input type="file" name="image" accept="image/*" />
									<small class="help-text">æˆ–è¼¸å…¥åœ–ç‰‡ç¶²å€ï¼š</small>
									<input type="url" name="image_url" placeholder="åœ–ç‰‡ç¶²å€ï¼ˆé¸å¡«ï¼‰" />
									<div class="form-actions">
										<button type="submit" class="button">é€å‡º</button>
									</div>
								</form>
							{% endif %}
						</section>
					</article>
				{% endfor %}
			</div>
		{% else %}
			<p class="empty-state">å°šç„¡å¿ƒå¾—ï¼Œæˆç‚ºç¬¬ä¸€å€‹åˆ†äº«çš„äººå§ï¼</p>
		{% endif %}
	</section>
</div>

{% if user.is_authenticated %}
	<a href="/post/new?vehicle={{ vehicle.id }}" class="button fab">ï¼‹ ç™¼è¡¨å¿ƒå¾—</a>
{% else %}
	<a href="/admin/login/?next=/vehicle/{{ vehicle.id }}/" class="button fab">ç™»å…¥å¾Œç™¼è¡¨</a>
{% endif %}
{% endblock %}

{% block extra_js %}
	{{ block.super }}
	<script src="{% static 'motry/js/vehicle_detail.js' %}"></script>
{% endblock %}
