{% extends "core/base.html" %}
{% load static motry_extras %}
{% block content %}
<div class="page-container page-stack">
	<section class="layout layout--split layout--align-top">
		<div class="card vehicle-visual">
			{% vehicle_showcase_image vehicle as showcase_image %}
			<div class="vehicle-hero__media">
				{% if showcase_image %}
					<img
						src="{{ showcase_image }}"
						alt="{{ vehicle.brand }} {{ vehicle.model }}"
						data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
					/>
				{% else %}
					<img
						src="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
						alt="{{ vehicle.brand }} {{ vehicle.model }}"
					/>
				{% endif %}
			</div>
			{% if user.is_authenticated %}
				<div class="hero-actions">
					<button
						type="button"
						class="button button-ghost favorite-toggle-button"
						data-favorite-toggle
						data-vehicle-id="{{ vehicle.id }}"
						data-in-favorite="{% if favorite_entry %}true{% else %}false{% endif %}"
					>
						{% if favorite_entry %}
							â­ å·²åœ¨æˆ‘çš„æœ€æ„›
						{% else %}
							â˜† åŠ å…¥æˆ‘çš„æœ€æ„›
						{% endif %}
					</button>
					<button
						type="button"
						class="button button-ghost garage-toggle-button"
						data-garage-toggle
						data-vehicle-id="{{ vehicle.id }}"
						data-in-garage="{% if user_vehicle_entry %}true{% else %}false{% endif %}"
					>
						{% if user_vehicle_entry %}
							â¤ï¸ å·²åœ¨æˆ‘çš„è»Šåº«
						{% else %}
							ğŸ¤ åŠ å…¥æˆ‘çš„è»Šåº«
						{% endif %}
					</button>
					<a href="{% url 'post_create' %}?vehicle={{ vehicle.id }}" class="button">ç™¼è¡¨å¿ƒå¾—</a>
					<a href="{% url 'user_garage' %}" class="button button-ghost">ç®¡ç†æˆ‘çš„è»Šåº«</a>
					<a href="{% url 'user_favorites' %}" class="button button-ghost">æŸ¥çœ‹æˆ‘çš„æœ€æ„›</a>
				</div>
				<div class="hero-subtitle hero-subtitle--compact">
					<p data-favorite-status>
						{% if favorite_entry %}
							å·²åŠ å…¥æˆ‘çš„æœ€æ„›ï¼Œæ—¥å¾Œå¯åœ¨ã€Œæˆ‘çš„æœ€æ„›ã€é é¢å¿«é€Ÿæ‰¾åˆ°å®ƒã€‚
						{% else %}
							å–œæ­¡é€™å°è»Šå—ï¼ŸæŒ‰ã€ŒåŠ å…¥æˆ‘çš„æœ€æ„›ã€å³å¯è¿½è¹¤ã€‚
						{% endif %}
					</p>
					<p data-garage-status>
						{% if user_vehicle_entry %}
							å·²æ–¼ {{ user_vehicle_entry.created_at|date:"Y-m-d" }} åŠ å…¥è»Šåº«ï¼Œå¯åœ¨ã€Œæˆ‘çš„è»Šåº«ã€ç®¡ç†å‚™è¨»èˆ‡ç…§ç‰‡ã€‚
						{% else %}
							è‹¥é€™æ˜¯ä½ çš„åº§é§•ï¼Œå¯åŠ å…¥æˆ‘çš„è»Šåº«ï¼Œé›†ä¸­ç®¡ç†å¿ƒå¾—å…§å®¹ã€‚
						{% endif %}
					</p>
				</div>
			{% else %}
				<p class="hero-subtitle hero-subtitle--compact">ç™»å…¥å¾Œå³å¯æ”¶è—é€™å°è»Šä¸¦åˆ†äº«ä½ çš„ä½¿ç”¨å¿ƒå¾—ã€‚</p>
				<div class="hero-actions">
					<a href="{% url 'login' %}?next=/vehicle/{{ vehicle.id }}/" class="button">ç™»å…¥åˆ†äº«</a>
					<a href="{% url 'register' %}" class="button button-ghost">åŠ å…¥ç¤¾ç¾¤</a>
				</div>
			{% endif %}
		</div>

		<div class="card vehicle-summary stack-sm">
			<span class="badge badge--ghost">Vehicle Overview</span>
			<h1 class="hero-title">{{ vehicle.brand }} {{ vehicle.model }}</h1>
			<p class="hero-subtitle">
				æ©Ÿè»Š
				{% if vehicle.years_from or vehicle.years_to %}
					ï½œå¹´ä»½ {{ vehicle.years_from|default:"?" }}{% if vehicle.years_to %} - {{ vehicle.years_to }}{% endif %}
				{% endif %}
			</p>
			<ul class="spec-pill-list">
				{% if vehicle.displacement_cc %}
					<li class="spec-pill">{{ vehicle.displacement_cc }} cc</li>
				{% endif %}
				{% if vehicle.cylinders %}
					<li class="spec-pill">{{ vehicle.cylinders }} ç¼¸</li>
				{% endif %}
				{% if vehicle.horsepower_ps %}
					<li class="spec-pill">{{ vehicle.horsepower_ps }} PS</li>
				{% endif %}
				{% if vehicle.generation %}
					<li class="spec-pill">{{ vehicle.generation }}</li>
				{% endif %}
			</ul>
			<div class="rating-block">
				<div class="rating-summary">
					<strong class="rating-summary__score">
						{% if vehicle.rating_count %}
							{{ vehicle.avg_rating|floatformat:1 }}
						{% else %}
							â€“
						{% endif %}
					</strong>
					<span class="rating-summary__label">å¹³å‡è©•åˆ†ï¼ˆå…± {{ vehicle.rating_count|default:0 }} å‰‡ï¼‰</span>
				</div>
				{% if rating_form %}
					<form action="{% url 'rate_vehicle' vehicle.id %}" method="post" class="rating-form inline-form inline-form--compact">
						{% csrf_token %}
						{{ rating_form.score }}
						<input type="hidden" name="next" value="{{ request.get_full_path }}" />
						<button type="submit" class="button">
							{% if user_rating %}æ›´æ–°è©•åˆ†{% else %}é€å‡ºè©•åˆ†{% endif %}
						</button>
					</form>
				{% elif not user.is_authenticated %}
					<p class="rating-login-hint">ç™»å…¥å¾Œå³å¯ç‚ºé€™å°è»Šè©•åˆ†ã€‚</p>
				{% endif %}
			</div>
			<div class="vehicle-intro" data-intro-section>
				<div class="vehicle-intro__header">
					<div>
						<h3>è»Šè¼›ç°¡ä»‹</h3>
						<p class="vehicle-intro__subtitle">éˆæ„Ÿä¾†è‡ªç¶­åŸºç™¾ç§‘ï¼Œç”±ç¤¾ç¾¤å”ä½œè£œå……ã€‚å…§å®¹ä¿æŒä¸­ç«‹ã€é™„ä¸Šå¯ä¿¡ä¾†æºï¼Œè®“æ›´å¤šäººç†è§£é€™å°è»Šçš„èƒŒæ™¯ã€‚</p>
					</div>
					{% if user.is_authenticated %}
						<button type="button" class="button button-ghost button-compact" data-intro-edit-trigger>
							âœï¸ {% if vehicle.intro_md %}è£œå……å…§å®¹{% else %}æ’°å¯«ä»‹ç´¹{% endif %}
						</button>
					{% else %}
						<a href="{% url 'login' %}?next={{ request.get_full_path }}" class="button button-ghost button-compact">ç™»å…¥å¾Œæ’°å¯«</a>
					{% endif %}
				</div>
				<div class="vehicle-intro__body">
					{% if vehicle.intro_md %}
						<article class="vehicle-intro__content" data-intro-content>
							{{ vehicle.intro_md|linebreaksbr }}
						</article>
					{% else %}
						<div class="vehicle-intro__empty" data-intro-empty>
							<p>ç›®å‰é‚„æ²’æœ‰è©³ç´°ä»‹ç´¹ã€‚å¯ä»¥è£œå……å®ƒçš„æ­·å²ã€å‹•åŠ›æ¶æ§‹ã€è¨­è¨ˆæ•…äº‹æˆ–å¸‚å ´å®šä½ã€‚</p>
							<p>åƒè€ƒç¶­åŸºç™¾ç§‘çš„å¯«æ³•ï¼šå…ˆæ¦‚è¿°æ•´é«”ï¼Œå†ç”¨çŸ­æ®µè½æè¿°äº®é»ï¼Œå¼•ç”¨å¯ä¿¡è³‡è¨Šä¾†æºã€‚</p>
						</div>
					{% endif %}

					{% if user.is_authenticated %}
						<div class="vehicle-intro__editor" data-intro-editor {% if not intro_form.errors %}hidden{% endif %}>
							<form action="{% url 'vehicle_intro_update' vehicle.id %}" method="post" class="stack-sm">
								{% csrf_token %}
								{{ intro_form.non_field_errors }}
								<div class="vehicle-intro__tips">
									<strong>ç·¨å¯«æŒ‡å—ï¼š</strong>
									<ul>
										<li>ä¿æŒä¸­ç«‹èªæ°£ï¼Œé¿å…å»£å‘Šæˆ–éåº¦ä¸»è§€çš„æè¿°ã€‚</li>
										<li>ç›¡é‡è£œå……å¹´ä»½ã€ä¸–ä»£ã€æŠ€è¡“äº®é»æˆ–é‡è¦äº‹ä»¶ã€‚</li>
										<li>å¼•ç”¨å¯ä¿¡ä¾†æºï¼ˆå®˜ç¶²ã€åª’é«”ã€ç¶­åŸºç™¾ç§‘ç­‰ï¼‰ï¼Œå¯ç”¨ Markdown é€£çµæ¨™è¨»ã€‚</li>
									</ul>
								</div>
								<label for="{{ intro_form.intro_md.id_for_label }}" class="vehicle-intro__label">å…§å®¹ï¼ˆæ”¯æ´ Markdownï¼‰</label>
								{{ intro_form.intro_md }}
								{% if intro_form.intro_md.help_text %}
									<p class="vehicle-intro__hint">{{ intro_form.intro_md.help_text }}</p>
								{% endif %}
								{% if intro_form.intro_md.errors %}
									<p class="form-error">{{ intro_form.intro_md.errors|join:", " }}</p>
								{% endif %}
								<div class="vehicle-intro__preview" data-intro-preview>
									<p class="vehicle-intro__preview-label">å³æ™‚é è¦½</p>
									<div class="vehicle-intro__preview-content" data-intro-preview-target>
										{{ intro_form.intro_md.value|default:intro_form.instance.intro_md|default:"è¼¸å…¥å¾Œå³å¯é è¦½æ®µè½ã€‚"|linebreaksbr }}
									</div>
								</div>
								<div class="form-actions">
									<button type="submit" class="button">å„²å­˜ç°¡ä»‹</button>
									<button type="button" class="button button-ghost" data-intro-cancel>å–æ¶ˆ</button>
								</div>
							</form>
						</div>
					{% endif %}
				</div>
			</div>
			<div class="spec-table">
				<h3 style="margin-top: 0; margin-bottom: 16px;">è©³ç´°è¦æ ¼</h3>
				{% if vehicle.years_from or vehicle.years_to %}
					<div class="spec-row">
						<strong>ä¸Šå¸‚å¹´ä»½</strong>
						<span>{{ vehicle.years_from|default:"-" }}{% if vehicle.years_to %} - {{ vehicle.years_to }}{% endif %}</span>
					</div>
				{% endif %}
				{% if vehicle.generation %}
					<div class="spec-row">
						<strong>ä¸–ä»£ / ä»£è™Ÿ</strong>
						<span>{{ vehicle.generation }}</span>
					</div>
				{% endif %}
				<div class="spec-row">
					<strong>æ’æ°£é‡</strong>
					<span>{% if vehicle.displacement_cc %}{{ vehicle.displacement_cc }} cc{% else %}-{% endif %}</span>
				</div>
				<div class="spec-row">
					<strong>ç¼¸æ•¸</strong>
					<span>{% if vehicle.cylinders %}{{ vehicle.cylinders }} ç¼¸{% else %}-{% endif %}</span>
				</div>
				<div class="spec-row">
					<strong>é¦¬åŠ›</strong>
					<span>{% if vehicle.horsepower_ps %}{{ vehicle.horsepower_ps }} PS{% else %}-{% endif %}</span>
				</div>
				{% if vehicle.msrp_new %}
					<div class="spec-row">
						<strong>æ–°è»Šå»ºè­°å”®åƒ¹</strong>
						<span>{{ vehicle.msrp_new|floatformat:0 }} å…ƒ</span>
					</div>
				{% endif %}
				{% if vehicle.used_price_min or vehicle.used_price_max %}
					<div class="spec-row">
						<strong>ä¸­å¤è»Šåƒ¹æ ¼</strong>
						<span>
							{% if vehicle.used_price_min %}{{ vehicle.used_price_min|floatformat:0 }}{% else %}?{% endif %}
							{% if vehicle.used_price_min and vehicle.used_price_max %} - {% endif %}
							{% if vehicle.used_price_max %}{{ vehicle.used_price_max|floatformat:0 }}{% endif %}
							{% if vehicle.used_price_min or vehicle.used_price_max %} å…ƒ{% endif %}
						</span>
					</div>
				{% endif %}
				<div class="spec-row">
					<strong>è³‡æ–™å»ºç«‹æ™‚é–“</strong>
					<span>{{ vehicle.created_at|date:"Y-m-d" }}</span>
				</div>
				{% if vehicle.updated_at %}
					<div class="spec-row">
						<strong>æœ€å¾Œæ›´æ–°</strong>
						<span>{{ vehicle.updated_at|date:"Y-m-d" }}</span>
					</div>
				{% endif %}
			</div>
		</div>
	</section>

	<section class="card vehicle-photos">
		<div class="section-heading">
			<div>
				<h2>è»Šè¼›ç¾ç…§</h2>
				<p class="hero-subtitle hero-subtitle--compact">
					ç”±è»Šä¸»èˆ‡ç²‰çµ²å”ä½œçš„ç…§ç‰‡é›†ï¼Œè£œä¸Šå®˜ç¶²æ²’æœ‰çš„è§’åº¦ã€‚è¶Šå¤šç¾ç…§ï¼Œè¶Šèƒ½å¹«åŠ©ä¸‹ä¸€ä½è»Šå‹èªè­˜é€™å°è»Šã€‚
				</p>
			</div>
		</div>
		{% if gallery_images %}
			<div class="gallery-strip vehicle-photos__strip">
				{% for img in gallery_images %}
					<figure class="vehicle-photo">
						<img
							src="{{ img.image_url_or_file }}"
							alt="{{ vehicle.brand }} {{ vehicle.model }} ç¾ç…§ {{ forloop.counter }}"
							loading="lazy"
							data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
						/>
					</figure>
				{% endfor %}
			</div>
		{% else %}
			<p class="empty-state empty-state--compact">é‚„æ²’æœ‰ç¤¾ç¾¤ç…§ç‰‡ï¼Œæˆç‚ºç¬¬ä¸€å€‹åˆ†äº«è€…å§ï¼</p>
		{% endif %}

		<div class="vehicle-photos__upload">
			{% if user.is_authenticated %}
				<form action="{% url 'vehicle_photo_upload' vehicle.id %}" method="post" enctype="multipart/form-data" class="stack-sm">
					{% csrf_token %}
					{{ photo_form.non_field_errors }}
					<label for="{{ photo_form.image.id_for_label }}" class="vehicle-photo__label">ä¸Šå‚³ç…§ç‰‡ï¼ˆJPG / PNGï¼Œ10MB å…§ï¼‰</label>
					{{ photo_form.image }}
					{% if photo_form.image.errors %}
						<p class="form-error">{{ photo_form.image.errors|join:", " }}</p>
					{% endif %}
					<label for="{{ photo_form.image_url.id_for_label }}" class="vehicle-photo__label">æˆ–è²¼ä¸Šå¯ä¿¡åœ–ç‰‡ç¶²å€</label>
					{{ photo_form.image_url }}
					{% if photo_form.image_url.errors %}
						<p class="form-error">{{ photo_form.image_url.errors|join:", " }}</p>
					{% endif %}
					<p class="vehicle-photo__hint">å»ºè­°åˆ†äº«æœ¬äººæ‹æ”æˆ–å¯å…¬é–‹ä½¿ç”¨çš„åœ–ç‰‡ï¼Œä¸Šå‚³å¾Œæœƒé¡¯ç¤ºåœ¨è»Šè¼›ç¾ç…§å€å¡Šã€‚</p>
					<div class="form-actions">
						<button type="submit" class="button">é€å‡ºç¾ç…§</button>
					</div>
				</form>
			{% else %}
				<p class="vehicle-photos__login-hint">ç™»å…¥å¾Œå³å¯ä¸Šå‚³ä½ çš„æ„›è»Šç…§ç‰‡ï¼Œå¹«åŠ©å…¶ä»–è»Šå‹å¿«é€Ÿäº†è§£é€™å°è»Šã€‚</p>
				<a href="{% url 'login' %}?next={{ request.get_full_path }}" class="button button-ghost">ç™»å…¥ä¸Šå‚³</a>
			{% endif %}
		</div>
	</section>

	<section class="card">
		<div class="section-heading">
			<div>
				<h2>è»Šä¸»å¿ƒå¾—èˆ‡è¨è«–</h2>
				<p class="hero-subtitle hero-subtitle--compact">é–±è®€çœŸå¯¦è»Šä¸»å¿ƒå¾—èˆ‡ç•™è¨€ï¼ŒæŒæ¡ä½¿ç”¨æ„Ÿå—ã€‚</p>
			</div>
			{% if user.is_authenticated %}
				<a href="{% url 'post_create' %}?vehicle={{ vehicle.id }}" class="button button-ghost">æ’°å¯«å¿ƒå¾—</a>
			{% else %}
				<a href="{% url 'login' %}?next=/vehicle/{{ vehicle.id }}/" class="button button-ghost">ç™»å…¥å¾Œåˆ†äº«</a>
			{% endif %}
		</div>

		{% if vehicle.posts.all %}
			<div class="post-stack">
				{% for post in vehicle.posts.all %}
					<article class="post-card">
						<div class="post-card__body">
							{{ post.body_text|linebreaksbr }}
						</div>
						{% if post.images.all %}
							<div class="post-card__gallery">
								{% for pi in post.images.all %}
									{% if pi.image %}
										<img
											src="{{ pi.image.url }}"
											alt="è²¼æ–‡åœ–ç‰‡ {{ forloop.counter }}"
											data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
										/>
									{% elif pi.image_url and not pi.image_url|is_default_image %}
										<img
											src="{{ pi.image_url }}"
											alt="è²¼æ–‡åœ–ç‰‡ {{ forloop.counter }}"
											data-fallback="{% vehicle_fallback_image vehicle.brand vehicle.model %}"
										/>
									{% endif %}
								{% endfor %}
							</div>
						{% endif %}
						{% if post.post_tags.all %}
							<div class="post-card__tags">
								{% for pt in post.post_tags.all %}
									<span class="post-card__tag">#{{ pt.tag.name }}</span>
								{% endfor %}
							</div>
						{% endif %}
						<div class="post-card__meta">
							<div class="post-card__meta-info">
								<span>ç”± {{ post.user.username|default:"åŒ¿åè»Šå‹" }} åˆ†äº«</span>
								<span>æ„›å¿ƒï¼š{{ post.num_likes }}</span>
								<span>ç•™è¨€ï¼š{{ post.num_comments }}</span>
								<span>{{ post.created_at|date:"Y-m-d H:i" }}</span>
							</div>
							{% if user.is_authenticated %}
								<div class="post-card__actions">
									<form action="/like/toggle/{{ post.id }}/" method="post" class="post-like-form">
										{% csrf_token %}
										<button type="submit" class="post-like-button" aria-label="å°é€™ç¯‡è²¼æ–‡æŒ‰æ„›å¿ƒ">
											<span class="post-like-button__icon" aria-hidden="true">â¤</span>
											<span class="post-like-button__label">æŒ‰æ„›å¿ƒ</span>
										</button>
									</form>
									{% if post.user_id == user.id or user.is_staff %}
										<form action="{% url 'post_delete' post.id %}" method="post" class="post-delete-form">
											{% csrf_token %}
											<input type="hidden" name="next" value="{{ request.get_full_path }}" />
											<button type="submit" class="post-delete-link">åˆªé™¤è²¼æ–‡</button>
										</form>
									{% endif %}
								</div>
							{% endif %}
						</div>
						<section class="comment-section">
							<h4 class="comment-section__title">ç•™è¨€</h4>
							{% if post.comments.all %}
								<div class="comment-thread">
									{% for c in post.comments.all %}
										{% if not c.parent_id %}
											{% include "motry/partials/comment_recursive.html" with comment=c post_id=post.id %}
										{% endif %}
									{% endfor %}
								</div>
							{% else %}
								<p class="empty-state empty-state--compact">é‚„æ²’æœ‰ç•™è¨€ã€‚</p>
							{% endif %}

							{% if user.is_authenticated %}
								<form action="/comment/new" method="post" enctype="multipart/form-data" class="comment-form">
									{% csrf_token %}
									<input type="hidden" name="post" value="{{ post.id }}" />
									<div class="comment-form__avatar" aria-hidden="true">
										{% if user.username %}
											{{ user.username|first|upper }}
										{% else %}
											æˆ‘
										{% endif %}
									</div>
									<div class="comment-form__fields">
										<textarea name="body_text" rows="2" placeholder="ç•™è¨€â€¦" class="comment-form__input" required></textarea>
										<div class="comment-form__actions">
											<label class="comment-form__upload" title="ä¸Šå‚³åœ–ç‰‡">
												ğŸ“·
												<input type="file" name="image" accept="image/*" class="comment-form__file-input" />
											</label>
											<input type="url" name="image_url" placeholder="åœ–ç‰‡ç¶²å€ï¼ˆé¸å¡«ï¼‰" class="comment-form__url" />
											<button type="submit" class="comment-form__submit">é€å‡º</button>
										</div>
									</div>
								</form>
							{% else %}
								<p class="comment-login-hint">ç™»å…¥å³å¯åƒèˆ‡ç•™è¨€è¨è«–ã€‚</p>
							{% endif %}
						</section>
					</article>
				{% endfor %}
			</div>
		{% else %}
			<p class="empty-state">å°šç„¡å¿ƒå¾—ï¼Œæˆç‚ºç¬¬ä¸€å€‹åˆ†äº«çš„äººå§ï¼</p>
		{% endif %}
	</section>
</div>

{% if user.is_authenticated %}
	<a href="/post/new?vehicle={{ vehicle.id }}" class="button fab">ï¼‹ ç™¼è¡¨å¿ƒå¾—</a>
{% else %}
	<a href="/admin/login/?next=/vehicle/{{ vehicle.id }}/" class="button fab">ç™»å…¥å¾Œç™¼è¡¨</a>
{% endif %}
{% endblock %}

{% block extra_js %}
	{{ block.super }}
	<script src="{% static 'motry/js/vehicle_detail.js' %}"></script>
{% endblock %}
